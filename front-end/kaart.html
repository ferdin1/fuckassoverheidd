<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaart van Noord-Nederland - Rijksoverheid</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="css/rijkshuisstijl.css">
    <style>
        /* Map-specific styles that must be inline for Leaflet */
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .edit-mode #map {
            cursor: crosshair;
        }

        .building-marker {
            background: var(--rijk-blue);
            color: white;
            border: 2px solid white;
            border-radius: var(--radius-card);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            font-size: 24px;
        }

        .building-marker:hover {
            background: #0d2a4a;
            transform: scale(1.1);
            transition: all 0.2s ease;
        }

        .marker-label {
            background: var(--rijk-blue);
            color: white;
            padding: 4px 8px;
            border-radius: var(--radius-button);
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: var(--radius-card);
            padding: 0;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .custom-popup .leaflet-popup-content {
            margin: 0;
            width: 200px !important;
        }

        .popup-header {
            background: var(--rijk-blue);
            color: white;
            padding: 10px 15px;
            font-weight: 600;
            font-size: 14px;
        }

        .popup-body {
            padding: 15px;
            background: white;
        }

        /* AANGEPAST: Witte tekst voor de Bekijk Functies knop */
        .popup-body .rijk-btn {
            color: white !important;
        }
    </style>
</head>

<body>
    <header class="rijk-top-bar">
        <div class="rijk-header-top">
            <a href="dashboard.html" class="rijk-logo-link">
                <img src="https://www.rijkshuisstijl.nl/publiek/general/filestreamer.ashx?d=vePBKGSkhy7hArZX2fPnf67BDM1fdkK%2B22LcON6gT80KUVyGS%2Fw1GGkIgB2LbnNfAa77kkFAGIPKK5Ll7A0Vp1X8BPrR%2FBHYwrYEdKpPX0ADg1F7Pu5vAfJ6VS4Bfl%2FXypjYJVLFt5eALy3vNueZGI5YAjdAF%2FSyy9cCYK4Ck91pjXT7KzerH3%2BkJpLxkmZ%2F6OPSkTN4WqfVbx68D1eFTOb7kil7Ka9AjS0J%2BPcL19DojCVnYR4PgeS6J2BGk%2FLaa7j%2B88BAel7x1W4jbKD5KEf%2Bu6TQdVuSMWuinTiOW7cPgSGSfmipO2Dq3VnXYBHm1nWBtPDHn3YlpZWu7fSFD4bd5t%2B2jMIUN81yTvThr%2BQ%3D"
                    alt="Rijksoverheid Logo" class="rijk-logo">
                <span class="rijk-org-name">Rijksoverheid Loopbaan</span>
                <span class="rijk-ministry">Ministerie van Justitie en Veiligheid</span>
            </a>
        </div>
        <div class="rijk-header-nav">
            <nav class="rijk-main-nav">
                <a href="dashboard.html" class="rijk-nav-link">Home</a>
                <a href="kaart.html" class="rijk-nav-link active">Kaart</a>
                <a href="functies.html" class="rijk-nav-link">Functies</a>
                <button class="rijk-nav-link">Menu</button>
            </nav>
            <div class="rijk-search-container">
                <input type="search" class="rijk-search-input" placeholder="Waar bent u naar op zoek?">
                <button class="rijk-search-btn">üîç</button>
            </div>
            <div>
                <div class="rijk-admin-controls" id="adminControls">
                    <label class="rijk-admin-toggle">
                        <div class="rijk-switch">
                            <input type="checkbox" id="editModeToggle">
                            <span class="rijk-switch-slider"></span>
                        </div>
                        <span>Bewerk Modus</span>
                    </label>
                </div>
                <a href="#" id="loginLink" class="rijk-login-btn">Inloggen</a>
            </div>
        </div>
    </header>

    <div class="rijk-map-container" id="map">
        <div class="rijk-map-info-panel">
            <h3 class="rijk-map-info-title">üó∫Ô∏è Hoe werkt het?</h3>
            <div class="rijk-map-steps">
                <div class="rijk-map-step">
                    <div class="rijk-map-step-number">1</div>
                    <div class="rijk-map-step-text"><strong>Verken de kaart</strong> - Scroll en zoom om alle
                        organisaties te zien</div>
                </div>
                <div class="rijk-map-step">
                    <div class="rijk-map-step-number">2</div>
                    <div class="rijk-map-step-text"><strong>Klik op een gebouw</strong> - Bekijk details over de
                        organisatie</div>
                </div>
                <div class="rijk-map-step">
                    <div class="rijk-map-step-number">3</div>
                    <div class="rijk-map-step-text"><strong>Bekijk functies</strong> - Lees meer over alle beschikbare
                        functies</div>
                </div>
            </div>
           
            </div>
        </div>
    </div>

    <div id="addPinModal" class="rijk-modal">
        <div class="rijk-modal-content">
            <h2>Nieuwe Pin Toevoegen</h2>
            <div class="rijk-form-group">
                <label class="rijk-label">Selecteer Functie:</label>
                <select id="functionSelect" class="rijk-select"></select>
            </div>
            <div class="flex-between flex-gap">
                <button class="rijk-btn rijk-btn-outline" onclick="closeModal()">Annuleren</button>
                <button class="rijk-btn" onclick="savePin()">Pin Plaatsen</button>
            </div>
        </div>
    </div>

    

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        function toggleMoreInfo() {
            const extraInfo = document.getElementById('extraInfo');
            extraInfo.classList.toggle('show');
            const btn = document.querySelector('.rijk-map-toggle-btn');
            btn.textContent = extraInfo.classList.contains('show') ? '‚úï Minder informatie' : '‚ÑπÔ∏è Meer informatie';
        }
    </script>
    <script src="auth.js"></script>

    <script>
        // Data Layer
        const API_URL = 'api';
        let functionsData = {};
        let mapPins = [];

        async function loadInitialData() {
            try {
                const fRes = await fetch(`${API_URL}/functies.php`);
                functionsData = await fRes.json();
                const pRes = await fetch(`${API_URL}/pins.php`);
                mapPins = await pRes.json();
                renderPins();
            } catch (err) {
                console.error("Data kon niet worden geladen:", err);
                mapPins = defaultPins;
                functionsData = JSON.parse(localStorage.getItem('cjib_functies')) || {};
                renderPins();
            }
        }

        async function savePinToDB(pin) {
            try {
                const res = await fetch(`${API_URL}/pins.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pin)
                });
                const data = await res.json();
                pin.id = data.id;
                return data;
            } catch (err) {
                console.error("Pin kon niet worden opgeslagen:", err);
            }
        }

        async function deletePinFromDB(id) {
            try {
                await fetch(`${API_URL}/pins.php?id=${id}`, { method: 'DELETE' });
            } catch (err) {
                console.error("Pin kon niet worden verwijderd:", err);
            }
        }

        const defaultPins = [
            { lat: 53.2010, lng: 5.7985, title: "CJIB", description: "Justitieel Incasso | MBO/HBO", link: "cjibpagina.html" },
            { lat: 53.2157, lng: 5.8010, title: "Justid", description: "Justiti√´le diensten | HBO", link: "#" },
            { lat: 53.2008, lng: 5.7997, title: "Gerechtshof Arnhem-Leeuwarden", description: "Hoger beroep | WO", link: "#" },
            { lat: 52.5929, lng: 6.5623, title: "RWS", description: "Infrastructuur | MBO/HBO", link: "#" },
            { lat: 52.7500, lng: 6.5000, title: "PI Veenhuizen", description: "Justiti√´le Inrichtingen | MBO/HBO", link: "#" },
            { lat: 53.2129, lng: 6.5626, title: "Belastingdienst", description: "Belastingheffing | MBO/HBO", link: "#" },
            { lat: 53.2200, lng: 6.6000, title: "Douane", description: "Douane & Accijns | MBO", link: "#" },
            { lat: 53.2100, lng: 6.5600, title: "DUO", description: "Onderwijsuitvoering | HBO/WO", link: "#" },
            { lat: 53.2600, lng: 6.6200, title: "RDW", description: "Voertuigregistratie | MBO/HBO", link: "rdw.html" },
            { lat: 53.2200, lng: 6.5800, title: "IND", description: "Immigratie | HBO", link: "#" },
            { lat: 53.2300, lng: 6.6500, title: "RDI", description: "Rijksoverheid Diensten | HBO/WO", link: "#" },
            { lat: 53.2350, lng: 6.5900, title: "IMG", description: "Immigratie diensten | HBO", link: "#" },
            { lat: 52.7000, lng: 6.5200, title: "RVO", description: "Ondernemend NL | HBO", link: "#" },
            { lat: 53.2008, lng: 5.7997, title: "Rechtbank Noord-Nederland", description: "Rechtspraak | HBO/WO", link: "#" }
        ];

        const map = L.map('map', {
            minZoom: 9,
            maxZoom: 18
        }).setView([53.1, 6.5], 9);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        let isEditMode = false;
        let tempLatLng = null;
        let markers = [];

        const isAdmin = typeof Auth !== 'undefined' && Auth.isAdmin();
        if (isAdmin) {
            document.getElementById('adminControls').style.display = 'flex';
        }

        function renderPins() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            mapPins.forEach((pin) => {
                const buildingIcon = L.divIcon({
                    html: `<div class="building-marker"><i class="fas fa-building"></i></div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40],
                    popupAnchor: [0, -40],
                    className: 'building-icon-wrapper'
                });

                const marker = L.marker([pin.lat, pin.lng], { icon: buildingIcon }).addTo(map);

                marker.bindTooltip(pin.title, {
                    permanent: true,
                    direction: 'top',
                    offset: [0, -50],
                    className: 'marker-label'
                });

                let popupContent = `
                    <div class="popup-header">${pin.title}</div>
                    <div class="popup-body">
                        <div style="font-size: 12px; color: #666;">${pin.description}</div>
                        <a href="${pin.link}" class="rijk-btn rijk-btn-small mt-sm">Bekijk Functies</a>
                    </div>
                `;

                marker.bindPopup(popupContent, { className: 'custom-popup' });
                marker.on('click', function () {
                    this.openPopup();
                });

                markers.push(marker);
            });
        }

        function closeModal() {
            document.getElementById('addPinModal').classList.remove('active');
        }

        function savePin() {
            const functionSelect = document.getElementById('functionSelect');
            const functionId = functionSelect.value;
            const functionName = functionSelect.options[functionSelect.selectedIndex].text;

            if (!tempLatLng) {
                alert('Selecteer eerst een locatie op de kaart');
                return;
            }

            const newPin = {
                lat: tempLatLng.lat,
                lng: tempLatLng.lng,
                title: functionName,
                description: 'Rijksoverheid functie',
                link: '#',
                functionId: functionId
            };

            savePinToDB(newPin).then(result => {
                mapPins.push(result);
                renderPins();
                closeModal();
                const toast = document.getElementById('toast');
                toast.style.display = 'block';
                setTimeout(() => toast.style.display = 'none', 3000);
            });
        }

        document.getElementById('editModeToggle').addEventListener('change', function () {
            isEditMode = this.checked;
            document.body.classList.toggle('edit-mode', isEditMode);
        });

        map.on('click', function (e) {
            if (isEditMode) {
                tempLatLng = e.latlng;
                document.getElementById('addPinModal').classList.add('active');
            }
        });

        function populateFunctionSelect() {
            const select = document.getElementById('functionSelect');
            Object.entries(functionsData).forEach(([id, func]) => {
                const option = document.createElement('option');
                option.value = id;
                option.text = func.titel || func.name || func;
                select.appendChild(option);
            });
        }

        loadInitialData().then(() => {
            populateFunctionSelect();
            renderPins();
        });
    </script>

</body>

</html>